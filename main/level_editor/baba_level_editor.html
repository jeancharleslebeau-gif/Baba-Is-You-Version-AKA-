<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>BabaIsU – Level Editor</title>

<style>
    body {
        background-color: #202020;
        color: #f0f0f0;
        font-family: sans-serif;
        text-align: center;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
    #toolbar {
        margin: 6px auto;
    }
    #canvas {
        margin: 4px auto;
        max-height: 70vh;
        overflow: auto;
    }
    #level {
        border-collapse: collapse;
        margin: auto;
    }
    #level td {
        border: 1px solid #303030;
        background-image: url('atlas.png');
        image-rendering: pixelated;
        padding: 0;
    }
    #tiles {
        margin: 4px auto;
        max-width: 100%;
        overflow-x: auto;
        white-space: nowrap;
    }
    #tiles .tile {
        width: 32px;
        height: 32px;
        display: inline-block;
        margin: 2px;
        border: 2px solid #000;
        background-image: url('atlas.png');
        image-rendering: pixelated;
        cursor: pointer;
    }
    #tiles .tile.selected {
        border-color: #ffcc00;
    }
    textarea {
        width: 90%;
        max-width: 900px;
        height: 140px;
        margin-top: 6px;
        font-family: monospace;
        font-size: 12px;
    }
    input[type="number"] {
        width: 60px;
    }
    button {
        margin: 3px;
        padding: 4px 10px;
        font-size: 13px;
    }
</style>
</head>

<body>

<h1 style="margin:6px 0 2px 0;">BabaIsU – Level Editor</h1>

<div id="toolbar">
    Largeur :
    <input type="number" id="widthInput" min="1" max="32" value="13">
    Hauteur :
    <input type="number" id="heightInput" min="1" max="24" value="13">
    <button id="applySize">Appliquer</button>
    <button id="clearGrid">Effacer</button>
</div>

<div id="tiles"></div>

<div id="canvas">
    <table id="level"></table>
</div>

<div>
    <button id="exportFileBtn" style="background-color:green;color:white;">Exporter (fichier)</button>
    <button id="exportTextBtn" style="background-color:#444;color:white;">Exporter (zone)</button>

    <button id="importFileBtn" style="background-color:orange;color:black;">Importer (fichier)</button>
    <button id="importTextBtn" style="background-color:purple;color:white;">Importer (zone)</button>

    <input type="file" id="fileToLoad" style="display:none;">
</div>

<textarea id="levelData" placeholder="Zone import/export"></textarea>

<script>
// -----------------------------------------------------------------------------
// CONFIG ATLAS / ZOOM
// -----------------------------------------------------------------------------
const ATLAS_TILE = 16;
const ATLAS_COLS = 16;
const ATLAS_ROWS = 4;

let gridWidth = 13;
let gridHeight = 13;
let currentZoom = 2;

// -----------------------------------------------------------------------------
// OBJECTS dans l'ordre de l'atlas (g_spriteIndex)
// -----------------------------------------------------------------------------
const OBJECTS = [
    "BABA","WALL","ROCK","FLAG","LAVA","GOOP","LOVE","EMPTY",
    "KEY","DOOR","WATER","ICE","BOX","","","",

    "TEXT_BABA","TEXT_WALL","TEXT_ROCK","TEXT_FLAG","TEXT_LAVA","TEXT_GOOP",
    "TEXT_LOVE","TEXT_EMPTY","TEXT_KEY","TEXT_DOOR","TEXT_WATER","TEXT_ICE",
    "TEXT_BOX","","","",

    "TEXT_IS","TEXT_PUSH","TEXT_STOP","TEXT_WIN","TEXT_YOU","TEXT_SINK",
    "TEXT_KILL","TEXT_SWAP","TEXT_HOT","TEXT_MELT","TEXT_MOVE","TEXT_OPEN",
    "TEXT_SHUT","TEXT_FLOAT","TEXT_PULL",""
];

// -----------------------------------------------------------------------------
// Génération dynamique CSS (palette fixe + grille zoomée)
// -----------------------------------------------------------------------------
function generateCSSForZoom(zoom) {
    const old = document.getElementById('dynamic-css');
    if (old) old.remove();

    const style = document.createElement('style');
    style.id = 'dynamic-css';

    // Grille : zoom adaptatif
    const atlasWidthGrid  = ATLAS_COLS * ATLAS_TILE * zoom;
    const atlasHeightGrid = ATLAS_ROWS * ATLAS_TILE * zoom;

    // Palette : zoom fixe ×2
    const paletteZoom = 2;
    const atlasWidthPalette  = ATLAS_COLS * ATLAS_TILE * paletteZoom;
    const atlasHeightPalette = ATLAS_ROWS * ATLAS_TILE * paletteZoom;

    let css = "";

    // Grille
    css += `#level td{
        width:${ATLAS_TILE*zoom}px;
        height:${ATLAS_TILE*zoom}px;
        background-size:${atlasWidthGrid}px ${atlasHeightGrid}px;
    }\n`;

    // Palette
    css += `#tiles .tile{
        width:${ATLAS_TILE*paletteZoom}px;
        height:${ATLAS_TILE*paletteZoom}px;
        background-size:${atlasWidthPalette}px ${atlasHeightPalette}px;
    }\n`;

    // Positions des sprites
    for (let i = 0; i < OBJECTS.length; i++) {
        const col = i % ATLAS_COLS;
        const row = Math.floor(i / ATLAS_COLS);

        const xGrid = -col * ATLAS_TILE * zoom;
        const yGrid = -row * ATLAS_TILE * zoom;

        const xPalette = -col * ATLAS_TILE * paletteZoom;
        const yPalette = -row * ATLAS_TILE * paletteZoom;

        css += `.obj-${i}{background-position:${xGrid}px ${yGrid}px;}\n`;
        css += `#tiles .obj-${i}{background-position:${xPalette}px ${yPalette}px;}\n`;
    }

    style.textContent = css;
    document.head.appendChild(style);
}

// -----------------------------------------------------------------------------
// PALETTE
// -----------------------------------------------------------------------------
let selectedObject = 0;

function buildPalette() {
    const tilesDiv = document.getElementById('tiles');
    tilesDiv.innerHTML = "";

    OBJECTS.forEach((name, index) => {
        if (!name) return;

        const div = document.createElement('div');
        div.className = `tile obj-${index}`;
        div.title = name;

        div.addEventListener('click', () => {
            selectedObject = index;
            document.querySelectorAll('#tiles .tile').forEach(t => t.classList.remove('selected'));
            div.classList.add('selected');
        });

        tilesDiv.appendChild(div);
    });

    const first = tilesDiv.querySelector('.tile');
    if (first) first.classList.add('selected');
}

// -----------------------------------------------------------------------------
// GRILLE
// -----------------------------------------------------------------------------
function buildGrid() {
    const table = document.getElementById('level');
    table.innerHTML = "";

    for (let y = 0; y < gridHeight; y++) {
        const tr = document.createElement('tr');

        for (let x = 0; x < gridWidth; x++) {
            const td = document.createElement('td');
            td.dataset.obj = 7;
            td.className = "obj-7";

            td.addEventListener('click', () => {
                td.dataset.obj = selectedObject;
                td.className = `obj-${selectedObject}`;
            });

            tr.appendChild(td);
        }
        table.appendChild(tr);
    }
}

// -----------------------------------------------------------------------------
// ZOOM ADAPTATIF
// -----------------------------------------------------------------------------
function updateZoom() {
    const marginX = 40;
    const marginY = 200;

    const availableWidth  = window.innerWidth  - marginX;
    const availableHeight = window.innerHeight - marginY;

    const zoomX = availableWidth  / (gridWidth  * ATLAS_TILE);
    const zoomY = availableHeight / (gridHeight * ATLAS_TILE);

    let zoom = Math.floor(Math.min(zoomX, zoomY));
    if (!isFinite(zoom) || zoom < 1) zoom = 1;
    if (zoom > 6) zoom = 6;

    currentZoom = zoom;
    generateCSSForZoom(currentZoom);
}

// -----------------------------------------------------------------------------
// OUTILS GRILLE
// -----------------------------------------------------------------------------
document.getElementById('applySize').addEventListener('click', () => {
    gridWidth = Math.min(32, Math.max(1, parseInt(widthInput.value)));
    gridHeight = Math.min(24, Math.max(1, parseInt(heightInput.value)));
    buildGrid();
    updateZoom();
});

document.getElementById('clearGrid').addEventListener('click', () => {
    document.querySelectorAll('#level td').forEach(td => {
        td.dataset.obj = 7;
        td.className = "obj-7";
    });
});

// -----------------------------------------------------------------------------
// EXPORT — ZONE
// -----------------------------------------------------------------------------
document.getElementById('exportTextBtn').addEventListener('click', () => {
    const trs = document.querySelectorAll('#level tr');
    const out = [];

    trs.forEach(tr => {
        const row = [];
        tr.querySelectorAll('td').forEach(td => {
            row.push(OBJECTS[parseInt(td.dataset.obj)]);
        });
        out.push(row.join(", "));
    });

    document.getElementById('levelData').value = out.join("\n");
});

// -----------------------------------------------------------------------------
// EXPORT — FICHIER
// -----------------------------------------------------------------------------
document.getElementById('exportFileBtn').addEventListener('click', () => {
    const text = document.getElementById('levelData').value.trim();
    if (!text) {
        alert("Exporter d'abord vers la zone de texte.");
        return;
    }

    const blob = new Blob([text], {type: "text/plain"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "level_export.txt";
    a.click();
});

// -----------------------------------------------------------------------------
// IMPORT — FICHIER
// -----------------------------------------------------------------------------
document.getElementById('importFileBtn').addEventListener('click', () => {
    document.getElementById('fileToLoad').click();
});

document.getElementById('fileToLoad').addEventListener('change', function () {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
        const text = reader.result;
        document.getElementById('levelData').value = text;
        importFromText(text);
    };
    reader.readAsText(file);
});

// -----------------------------------------------------------------------------
// IMPORT — ZONE
// -----------------------------------------------------------------------------
document.getElementById('importTextBtn').addEventListener('click', () => {
    const text = document.getElementById('levelData').value.trim();
    if (!text) {
        alert("La zone de texte est vide.");
        return;
    }
    importFromText(text);
});

// -----------------------------------------------------------------------------
// Fonction commune d'import
// -----------------------------------------------------------------------------
function importFromText(text) {
    const lines = text.split("\n").map(l => l.trim()).filter(l => l.length > 0);
    if (lines.length === 0) return;

    const h = lines.length;
    const w = lines[0].split(",").length;

    gridWidth = Math.min(32, w);
    gridHeight = Math.min(24, h);

    widthInput.value = gridWidth;
    heightInput.value = gridHeight;

    buildGrid();

    const trs = document.querySelectorAll('#level tr');

    for (let y = 0; y < gridHeight; y++) {
        const parts = (lines[y] || "").split(",").map(s => s.trim());
        const tds = trs[y].querySelectorAll('td');

        for (let x = 0; x < gridWidth; x++) {
            const name = (parts[x] || "EMPTY").toUpperCase();
            const idx = OBJECTS.indexOf(name);
            const id = (idx >= 0) ? idx : 7;

            const td = tds[x];
            td.dataset.obj = id;
            td.className = `obj-${id}`;
        }
    }

    updateZoom();
}

// -----------------------------------------------------------------------------
// INIT
// -----------------------------------------------------------------------------
buildPalette();
buildGrid();
updateZoom();
window.addEventListener('resize', updateZoom);
</script>

</body>
</html>
